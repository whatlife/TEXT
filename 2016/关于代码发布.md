
[关于代码发布](https://github.com/fouber/blog/issues/8#issuecomment-209728910)
===================


发布静态资源看你们自己的部署方案吧。一般是公司内撘一个ci系统，比如jenkins，然后在上面安装运维提供的部署脚本，然后配置gitlab（通常不用github，防止泄密）的webhook，一有提交就发请求到jenkins上，jenkins拉取代码，调用fis构建，然后把产出的代码通过运维脚本推送到测试或者生产环境。大致的流程是：

- 内网搭建gitlab/svn
- 内网搭建ci系统（jenkins）
- 在ci系统所在机器上安装fis、运维推送脚本
- 配置gitlab的webhook，一有提交就发请求给jenkins
- jenkins中创建job，填写gitlab中的url，填写hook脚本
运行效果：


- 开发人员提交代码，gitlab触发webhook，推送信息到jenkins
- jenkins根据推送的信息执行对应的job
- job中的脚本clone对应的分支，调用构建工具对代码进行构建
- 使用运维脚本将构建完成的结果推送到测试/生产服务器。

![enter image description here](https://cloud.githubusercontent.com/assets/536297/8396008/760001e6-1dc5-11e5-972f-404614ac5101.png)



----------

> 上图中的SCRAT是我们基于FIS定制的自己的工具


总之效果就是【提交代码】→【自动部署】，【自动部署】包括了【构建】+【代码推送】

> 我所在的前一家公司里，其实也是这么部署。开发人员提交代码到dev，ci`检测`到有代码更新，则执行jobs，发布到开发环境。
> dev merge 到master，jenkins执行job，此时为测试环境。
> 大概与上图的流程是一致。

## 如果
以上是在有专门的运维人员的情况下发布流程，因为涉及到jenkins，运维脚本等需要专业人员来操作，那么小型公司，小型团队如果想到构建一套代码发布系统，需要通过哪些渠道，学习哪些知识才能做到这件事情？


开发流程方面，至少涉及四个平台：

- 代码托管
- 持续集成
- 代码库
- 运维操作


『代码托管平台』主要是git/svn的托管平台，现在应该很多人在用 gitlab，用这类平台的主要目的是利用其中的『hook』功能，就是可以在这类平台上设置代码提交之后要做哪些操作，这样我们可以在开发者提交代码之后把提交信息推送到持续集成平台。

『持续集成平台』常用来做自动构建和测试，主流的是 Jenkins CI 和 Gitlab CI ，代码托管平台发现有代码提交之后，会把提交信息推送到持续集成平台，持续集成平台会根据提交信息拉取指定的git/svn分支，然后根据开发者在平台上的配置对项目进行自动化构建和测试，然后把构建后的代码打个tar.gz包推送到代码库存储起来。

『代码库平台』其实就是一个存储持续集成平台每次构建结果的地方，根据构建时间来存放，这样运维操作平台在部署的时候就可以从代码库拉取代码进行上线部署了。

『运维操作平台』主要的工作就是从代码库拉取指定的代码部署到指定的环境中。这些一般需要开发者操作，这里一般会有『上线单』的概念，每次发布前配置一份上线单，包括上线版本，上线说明，指定拉取的代码库中哪个代码包，部署到哪些机器上，部署顺序等。每个上线单可以视为一个部署版本，遇到问题需要回滚的时候直接重新执行之前稳定时期的上线单就行了。

开发者提交代码后，整个持续集成的自动化的流程为：

>开发者：git push
    → 代码托管平台：hook
    → 持续集成平台：build && test && tar && push
      → 代码库：save

部署过程就是：

>运维操作平台：
   * 创建上线单
   * 说明部署原因
   * 指定代码库的包(从代码库拉取)
   * 指定部署机器
   * 启动部署
   * 记录上线单
   * 回滚

一个完整的自动化流程我感觉至少需要上述4个节点，其中前三个可以由前端自行组建，找个限制的台式机，配置好一点，装一个linux系统，撘gitlab、jenkins，jenkins自带归档功能（程序包列表），可以省掉代码库平台。与运维平台的打通（主要是代码库的接入部分）就要和你们的运维团队协商完成了，这个通常都不是什么难事。

不推荐由持续集成平台直接推送构建结果到运维然后自动部署，这种方式非常危险，所以一定要有代码库，能记录历史版本，找到备份，方便回滚，而且运维操作是主动拉取代码，不是被动推送，增加了安全性